<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<!--
  A web-component grid layout of filterable items.

  Example:

  ```html
    <app-grid 
      item-size="64">
    </app-grid>
  ```

  @demo
-->
<dom-module id="app-grid">
  <template>
    <style>
      :host {
        display: block;
        border: 1px dashed red;
      }
      #grid {
        position: relative;
      }
      #grid > div {
        display: block;
        position: absolute;
        transition: top 1s, left 1s, opacity 1s;
        box-sizing: border-box;
      }
      /* following will be provided from clients */
      .item {
        border-radius: 4px;
        box-shadow: 4px 4px 8px lightgray;
        border: 1px solid gray;
        height: 100%;
        text-align: center;
        padding: 8px;
      }
    </style>
    <div id="grid">
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
      <div>
        <div class="item">.item</div>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'app-grid',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      properties: {
        /**
         * The rectangular size of each item in the grid
         */
        itemSize: {
          type: Number,
          value: 128
          // TODO check if supplied number is positive
        },
        /**
         * The rectangular margin of each item in the grid
         */
        itemMargin: {
          type: Number,
          value: 16
          // TODO check if supplied number is positive
        }
      },


      listeners: {
        'iron-resize': '_onIronResize'
      },


      ready: function() {
        var gridEl, itemEls, itemEl, k;

        gridEl = Polymer.dom(this.$.grid);
        itemEls = gridEl.children;
        for (k = 0; k < itemEls.length; k++) {
          itemEl = itemEls[k];
          itemEl.style.width = itemEl.style.height = this.itemSize + 'px';
          itemEl.style.opacity = 0;
          //itemEl.style.top = 0;
          //itemEl.style.left = 0;
        }
      },


      attached: function() {
        this.async(this.notifyResize, 1);
      },


      get parent() {
        if (this.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
          return this.parentNode.host;
        }
        return this.parentNode;
      },


      _onIronResize: function() {
        var gridEl, gridWidth, itemEls, itemEl, itemWidth, itemHeight, 
            rows, cols, colIdx, rowIdx, k,
            paddingTop, paddingLeft;

        gridEl = Polymer.dom(this.$.grid);
        itemEls = gridEl.children;

        gridWidth = +window.getComputedStyle(gridEl.node).width.replace('px',''); // this.parent.offsetWidth;
        itemWidth = itemHeight = this.itemSize + this.itemMargin;
        cols = Math.floor(gridWidth / itemWidth);
        paddingTop = this.itemMargin;
        paddingLeft = (gridWidth - (cols * this.itemSize) - ((cols-1) * this.itemMargin)) / 2;
     
        for (k = 0; k < itemEls.length; k++) {
          itemEl = itemEls[k];
          colIdx = Math.floor(k % cols);
          rowIdx = Math.floor(k / cols);
          itemEl.style.opacity = 1;
          itemEl.style.top = ((rowIdx * itemHeight) + paddingTop) + 'px';
          itemEl.style.left = ((colIdx * itemWidth) + paddingLeft) + 'px';
        }
        rows = (rowIdx + 1);

        gridEl.node.style.height = ((rows * itemHeight) + paddingTop) + 'px';
      }
    });
  </script>
</dom-module>