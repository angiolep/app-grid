<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<!--
  A web-component grid layout of filterable items.

  Example:

  ```html
    <app-grid 
      item-size="64">
    </app-grid>
  ```

  @demo
-->
<dom-module id="app-grid">
  <template>
    <style>
      :host {
        display: block;
        border: 1px dashed red;
      }
      .grid {
        position: relative;
      }
      .item {
        display: block;
        position: absolute;
        transition: top 1s, left 1s, opacity 1s;
        box-sizing: border-box;
        @apply(--item-theme);
      }
    </style>
    <div id="grid" class="grid"></div>
  </template>
  <script>
  ;!function() {
    Polymer({
      is: 'app-grid',

      behaviors: [
        Polymer.Templatizer,
        Polymer.IronResizableBehavior
      ],

      properties: {
        // TODO make use of a Custom Property for CSS Variable
        /**
         * The width and height in pixels of each item in the grid
         */
        itemSize: {
          type: Number,
          value: 128
        },
        /**
         * The margin in pixels set around each item in the grid
         */
        itemSpacing: {
          type: Number,
          value: 16
        },
        /**
         * The array of items to layout in the grid
         */
        items: {
          type: Array,
          value: function() { return new Array(); },
          observer: '_itemsChanged'
        }
        // TODO animated
      },


      listeners: {
        'iron-resize': '_onIronResize'
      },


      ready: function() {
        // TODO this._itemsChanged();
      },


      attached: function() {
        //this.async(this.notifyResize, 1);
      },


      get parent() {
        if (this.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
          return this.parentNode.host;
        }
        return this.parentNode;
      },


      _onIronResize: function() {
        this._layout();
      },


      _itemsChanged: function(newValue, oldValue) {
        var userTemplate, item, gridEl;

        if (newValue.length > 0) {
          userTemplate = Polymer.dom(this).querySelector('template');
          if (userTemplate) {
            this.templatize(userTemplate);
          } else {
            console.warn('app-grid requires a template to be provided in light-dom');
          }

          gridEl = Polymer.dom(this.$.grid);
          while(gridEl.firstChild) gridEl.removeChild(gridEl.firstChild);

          for (k = 0; k < newValue.length; k++) {
            var itemEl = document.createElement('div');
            itemEl.classList.add('item');
            // TODO make use of a Custom Property for CSS Variable
            itemEl.style.width = itemEl.style.height = this.itemSize + 'px';
            itemEl.style.opacity = 0;
            //itemEl.style.top = 0;
            //itemEl.style.left = 0;
            gridEl.appendChild(itemEl);

            userEl = this.stamp(null);
            userEl.item = newValue[k];
            itemEl.appendChild(userEl.root);
          }
          this._layout();
        }
      },


      _layout: function() {
        var gridEl, gridWidth, itemEls, itemEl, itemWidth, itemHeight, rows, cols, colIdx, rowIdx, k, paddingTop, paddingLeft;
        gridEl = Polymer.dom(this.$.grid).node;
        itemEls = Polymer.dom(gridEl).querySelectorAll('.item');
        if (itemEls.length > 0) {

          gridWidth = +window.getComputedStyle(gridEl).width.replace('px',''); // this.parent.offsetWidth;
          itemWidth = itemHeight = this.itemSize + this.itemSpacing;
          cols = Math.floor(gridWidth / itemWidth);
          paddingTop = this.itemSpacing;
          paddingLeft = (gridWidth - (cols * this.itemSize) - ((cols-1) * this.itemSpacing)) / 2;
       
          for (k = 0; k < itemEls.length; k++) {
            itemEl = itemEls[k];
            colIdx = Math.floor(k % cols);
            rowIdx = Math.floor(k / cols);
            itemEl.style.opacity = 1;
            itemEl.style.top = ((rowIdx * itemHeight) + paddingTop) + 'px';
            itemEl.style.left = ((colIdx * itemWidth) + paddingLeft) + 'px';
          }
          rows = (rowIdx + 1);

          gridEl.style.height = ((rows * itemHeight) + paddingTop) + 'px';
        }
      }
    });
  }();
  </script>
</dom-module>